<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة شهادات السيارات</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2b6cb0;
      --primary-dark: #2c5282;
      --primary-light: #bee3f8;
      --secondary: #4c51bf;
      --success: #38a169;
      --success-light: #c6f6d5;
      --danger: #e53e3e;
      --danger-light: #fed7d7;
      --warning: #dd6b20;
      --warning-light: #feebc8;
      --info: #3182ce;
      --info-light: #ebf8ff;
      --light: #f7fafc;
      --dark: #1a202c;
      --gray: #718096;
      --light-gray: #edf2f7;
      --border-radius: 10px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: #f8fafc;
      color: var(--dark);
      line-height: 1.6;
    }
    
    /* شاشة التحميل */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loader {
      width: 60px;
      height: 60px;
      border: 5px solid var(--primary-light);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    .loader-text {
      font-size: 18px;
      font-weight: 500;
      color: var(--primary);
      margin-top: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* تسجيل الدخول */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #2b6cb0 0%, #4c51bf 100%);
      padding: 20px;
    }
    
    .auth-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 100%;
      max-width: 420px;
      padding: 40px;
      text-align: center;
      transform: translateY(0);
      transition: var(--transition);
    }
    
    .auth-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    
    .auth-icon {
      font-size: 48px;
      color: var(--primary);
      margin-bottom: 20px;
    }
    
    .auth-title {
      color: var(--primary);
      margin-bottom: 25px;
      font-size: 24px;
      font-weight: 700;
    }
    
    /* النموذج العام */
    .form-group {
      margin-bottom: 20px;
      text-align: right;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 14px;
    }
    
    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      transition: var(--transition);
      background-color: white;
      font-family: 'Tajawal', sans-serif;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.2);
      outline: none;
    }
    
    /* الأزرار */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      gap: 8px;
      font-family: 'Tajawal', sans-serif;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-success:hover {
      background-color: #2f855a;
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-warning:hover {
      background-color: #c05621;
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-danger:hover {
      background-color: #c53030;
    }
    
    .btn-info {
      background-color: var(--info);
    }
    
    .btn-info:hover {
      background-color: #2b6cb0;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background-color: rgba(43, 108, 176, 0.1);
    }
    
    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    /* الرسائل */
    .alert {
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert-success {
      background-color: var(--success-light);
      color: #22543d;
      border-left: 4px solid var(--success);
    }
    
    .alert-danger {
      background-color: var(--danger-light);
      color: #742a2a;
      border-left: 4px solid var(--danger);
    }
    
    .alert-warning {
      background-color: var(--warning-light);
      color: #7b341e;
      border-left: 4px solid var(--warning);
    }
    
    .alert-info {
      background-color: var(--info-light);
      color: #2a4365;
      border-left: 4px solid var(--info);
    }
    
    /* التخطيط العام */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--light-gray);
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .app-title {
      color: var(--primary);
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
    }
    
    /* البطاقات */
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .card-title {
      color: var(--primary);
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* جدول السجلات */
    .table-responsive {
      overflow-x: auto;
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
      margin-bottom: 20px;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    
    .table th {
      background-color: var(--light);
      font-weight: 600;
      color: var(--dark);
      padding: 14px 16px;
      text-align: right;
      border-bottom: 2px solid var(--light-gray);
    }
    
    .table td {
      padding: 12px 16px;
      text-align: right;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .table tr:last-child td {
      border-bottom: none;
    }
    
    .table tr:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }
    
    .no-data i {
      font-size: 48px;
      margin-bottom: 15px;
      color: var(--light-gray);
    }
    
    /* أنيميشن */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    
    /* أنماط جديدة للنوافذ المنبثقة */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 25px;
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .modal-body {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    
    .modal-field {
      margin-bottom: 15px;
    }
    
    .modal-label {
      font-weight: 600;
      color: var(--gray);
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .modal-value {
      padding: 10px;
      background: var(--light-gray);
      border-radius: 6px;
      word-break: break-word;
    }
    
    /* أنماط جديدة لزر التحديث */
    .refresh-btn {
      background-color: var(--info);
      color: white;
    }
    
    /* أنماط للأشرطة الجماعية */
    .bulk-actions {
      background: var(--light);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      display: none;
      justify-content: flex-start;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* أنماط لحالات السجلات */
    .status-approved {
      color: var(--success);
      font-weight: 600;
    }
    
    .status-rejected {
      color: var(--danger);
      font-weight: 600;
    }
    
    .status-pending {
      color: var(--warning);
      font-weight: 600;
    }
    
    /* أنماط الصفحات */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .page-item {
      list-style: none;
    }
    
    .page-link {
      display: block;
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      color: var(--primary);
      text-decoration: none;
      transition: var(--transition);
    }
    
    .page-link:hover {
      background-color: var(--light-gray);
    }
    
    .page-link.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* حقل البحث */
    .search-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      transition: var(--transition);
      font-family: 'Tajawal', sans-serif;
    }
    
    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.2);
      outline: none;
    }
    
    /* خانة الاختيار */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .checkbox-input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* شريط التقدم */
    .progress-container {
      width: 100%;
      background-color: var(--light-gray);
      border-radius: 8px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 10px;
      background-color: var(--primary);
      border-radius: 8px;
      transition: width 0.3s ease;
    }
    
    /* راديو بوتن */
    .radio-group {
      display: flex;
      gap: 15px;
      margin: 10px 0;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    
    /* متجاوب مع الجوال */
    @media (max-width: 768px) {
      .auth-card {
        padding: 30px 20px;
      }
      
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-info {
        width: 100%;
        justify-content: space-between;
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .modal-body {
        grid-template-columns: 1fr;
      }
      
      .filter-container {
        flex-direction: column;
        gap: 10px;
      }
      
      .filter-options {
        width: 100%;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .radio-group {
        flex-direction: column;
        gap: 8px;
      }
    }

    /* أنماط إضافية لقائمة السائقين */
    datalist {
      max-height: 200px;
      overflow-y: auto;
    }

    /* إخفاء العناصر */
    .hidden {
      display: none !important;
    }
    
    /* فلتر الحالة */
    .filter-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .filter-options {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-label {
      font-weight: 600;
      font-size: 14px;
    }
    
    /* بطاقة معلومات النظام */
    .system-info-card {
      background: linear-gradient(135deg, #2b6cb0 0%, #4c51bf 100%);
      color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 30px;
    }
    
    .system-info-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .system-info-text {
      margin-bottom: 15px;
      line-height: 1.7;
    }
    
    /* شريط الأدوات */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    /* أيقونات الحالة */
    .status-icon {
      margin-left: 5px;
    }
    
    /* شريط التبويبات */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--light-gray);
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
      font-weight: 600;
    }
    
    .tab:hover:not(.active) {
      border-bottom: 3px solid var(--primary-light);
    }
/* أضف هذه الأنماط في قسم الـ style */
@media (max-width: 768px) {
  .desktop-only {
    display: none;
  }
  
  .car-row {
    display: flex;
    flex-direction: column;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    padding: 10px;
  }
  
  .car-row td {
    display: block;
    width: 100% !important;
    padding: 5px 0;
    border: none;
  }
  
  .mobile-label {
    font-weight: 600;
    font-size: 14px;
    color: var(--dark);
    margin-bottom: 3px;
    display: block;
  }
  
  .car-row .btn {
    margin-top: 10px;
    width: 100%;
  }
}
  </style>
</head>
<body>
  <!-- شاشة التحميل -->
  <div id="loaderScreen" class="loader-container">
    <div class="loader"></div>
    <div class="loader-text">جاري تحميل النظام...</div>
  </div>

  <!-- شاشة تسجيل الدخول -->
  <div id="loginScreen" class="auth-container hidden">
    <div class="auth-card fade-in">
      <div class="auth-icon">
        <i class="fas fa-truck-moving"></i>
      </div>
      <h1 class="auth-title">نظام إدارة شهادات السيارات</h1>
      <form id="loginForm">
        <div class="form-group">
          <label for="username" class="form-label">اسم المستخدم</label>
          <input type="text" id="username" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="password" class="form-label">كلمة المرور</label>
          <input type="password" id="password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-block">
          <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
        </button>
      </form>
      <div id="loginMessage" class="alert hidden"></div>
    </div>
  </div>

  <!-- شاشة التطبيق -->
  <div id="appScreen" class="container hidden">
    <!-- بطاقة معلومات النظام -->
    <div class="system-info-card fade-in">
      <h2 class="system-info-title">
        <i class="fas fa-truck"></i> نظام إدارة شهادات السيارات
      </h2>
      <p class="system-info-text">
        نظام متكامل لإدارة شهادات سيارات النقل والتوريدات، يتيح تسجيل الشهادات ومتابعتها وإدارتها بسهولة وكفاءة.
      </p>
    </div>
    
    <!-- شريط التبويبات -->
    <div class="tabs">
      <div class="tab active" data-tab="register">تسجيل شهادات</div>
      <div class="tab" data-tab="records">سجلات الشهادات</div>
      <div class="tab" data-tab="reports">التقارير</div>
    </div>
    
    <!-- تبويب تسجيل الشهادات -->
    <div id="registerTab" class="tab-content">
      <!-- بطاقة تسجيل شهادة جديدة -->
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-plus-circle"></i> تسجيل شهادات جديدة
          </h2>
        </div>
        
        <form id="dataForm">
          <div class="form-group">
            <label for="date" class="form-label">تاريخ الشهادة *</label>
            <input type="date" id="date" class="form-control" required>
          </div>
          
<div class="cars-form">
  <div class="table-responsive">
    <table class="cars-table">
      <thead class="desktop-only">
        <tr>
          <th>اسم السائق *</th>
          <th>رقم الشهادة *</th>
          <th>اسم المدرسة *</th>
          <th>هاتف المدير</th>
          <th>ملاحظة</th>
          <th style="width: 50px;"></th>
        </tr>
      </thead>
      <tbody id="carsContainer">
        <!-- العناصر ستضاف هنا ديناميكيًا -->
        <tr class="car-row">
          <td>
            <div class="mobile-label">اسم السائق *</div>
            <input type="text" class="form-control driver-name" list="driversList" placeholder="اسم السائق" required>
          </td>
          <td>
            <div class="mobile-label">رقم الشهادة *</div>
            <input type="text" class="form-control certificate-number" placeholder="رقم الشهادة" required>
          </td>
          <td>
            <div class="mobile-label">اسم المدرسة *</div>
            <input type="text" class="form-control school-name" placeholder="اسم المدرسة" required>
          </td>
          <td>
            <div class="mobile-label">هاتف المدير</div>
            <input type="text" class="form-control manager-phone" placeholder="هاتف المدير">
          </td>
          <td>
            <div class="mobile-label">ملاحظة</div>
            <input type="text" class="form-control notes" placeholder="ملاحظة">
          </td>
          <td>
            <button type="button" class="btn btn-danger btn-sm remove-car" disabled>
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <datalist id="driversList">
    <!-- سيتم ملؤه ديناميكيًا من ورقة الموظفين -->
  </datalist>
  
  <button type="button" id="addCarBtn" class="btn btn-outline">
    <i class="fas fa-plus"></i> إضافة سجل
  </button>
</div>
          
          <div id="duplicateMessage" class="alert alert-warning hidden">
            <i class="fas fa-exclamation-circle"></i>
            <span id="duplicateText"></span>
          </div>
          
          <div id="message" class="alert hidden">
            <i class="fas fa-info-circle"></i>
            <span id="messageText"></span>
          </div>
          
          <div class="action-buttons">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i> حفظ السجلات
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- تبويب سجلات الشهادات -->
    <div id="recordsTab" class="tab-content hidden">
      <!-- شريط الأدوات -->
      <div class="toolbar">
        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="ابحث برقم الشهادة...">
          <button id="searchBtn" class="btn btn-info">
            <i class="fas fa-search"></i> بحث
          </button>
        </div>
        
        <div class="filter-container">
          <div class="filter-options">
            <div class="filter-group">
              <span class="filter-label">فلترة حسب:</span>
              <select id="timeFilter" class="form-control">
                <option value="10">آخر 10 أيام</option>
                <option value="20">آخر 20 يوم</option>
                <option value="month">الشهر الحالي</option>
                <option value="all">جميع السجلات</option>
              </select>
            </div>
            <div class="filter-group">
              <select id="statusFilter" class="form-control">
                <option value="all">جميع الحالات</option>
                <option value="معتمد">معتمد</option>
                <option value="مرفوض">مرفوض</option>
                <option value="قيد الانتظار">قيد الانتظار</option>
              </select>
            </div>
          </div>
          <button id="refreshBtn" class="btn refresh-btn">
            <i class="fas fa-sync-alt"></i> تحديث
          </button>
        </div>
      </div>
      
      <!-- الأشرطة الجماعية -->
      <div id="bulkActions" class="bulk-actions">
        <span id="selectedCount">0 سجل محدد</span>
        <button id="approveSelectedBtn" class="btn btn-success btn-sm">
          <i class="fas fa-check"></i> الموافقة على المحدد
        </button>
        <button id="rejectSelectedBtn" class="btn btn-danger btn-sm">
          <i class="fas fa-times"></i> رفض المحدد
        </button>
        <button id="clearSelectionBtn" class="btn btn-outline btn-sm">
          <i class="fas fa-times-circle"></i> إلغاء التحديد
        </button>
      </div>
      
      <!-- بطاقة سجلات الشهادات -->
      <div class="card fade-in">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>التاريخ</th>
                <th>السائق</th>
                <th>رقم الشهادة</th>
                <th>اسم المدرسة</th>
                <th>هاتف المدير</th>
                <th>ملاحظة</th>
                <th>مسجل بواسطة</th>
                <th>حالة الطلب</th>
                <th style="width: 120px;">إجراءات</th>
              </tr>
            </thead>
            <tbody id="recordsBody">
              <!-- البيانات ستضاف هنا عبر الجافاسكربت -->
            </tbody>
          </table>
          <div id="noRecords" class="no-data">
            <i class="fas fa-info-circle"></i>
            <p>لا توجد سجلات متاحة</p>
          </div>
          <div id="pagination" class="pagination"></div>
        </div>
      </div>
    </div>
    
    <!-- تبويب التقارير -->
    <div id="reportsTab" class="tab-content hidden">
      <div class="card fade-in">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-chart-bar"></i> تقارير الشهادات
          </h2>
        </div>
        <div class="card-body">
          <p>هنا سيتم عرض التقارير والإحصائيات الخاصة بالشهادات.</p>
          <!-- يمكن إضافة المزيد من المحتوى هنا -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- نافذة عرض التفاصيل المنبثقة -->
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>تفاصيل السجل</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- سيتم ملؤه ديناميكيًا -->
      </div>
    </div>
  </div>

  <!-- نافذة تأكيد الإضافة -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>تأكيد إضافة السجلات</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="confirmRecordsList" style="margin-bottom: 20px;"></div>
        <div class="action-buttons">
          <button id="confirmSubmitBtn" class="btn btn-success">
            <i class="fas fa-check"></i> تأكيد الإضافة
          </button>
          <button id="cancelSubmitBtn" class="btn btn-outline">
            <i class="fas fa-edit"></i> العودة للتعديل
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- نافذة تأكيد الإجراء -->
  <div id="actionConfirmModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="actionConfirmTitle">تأكيد الإجراء</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p id="actionConfirmMessage">هل أنت متأكد من تنفيذ هذا الإجراء؟</p>
        <div class="action-buttons">
          <button id="proceedActionBtn" class="btn btn-success">
            <i class="fas fa-check"></i> متابعة
          </button>
          <button id="cancelActionBtn" class="btn btn-outline">
            <i class="fas fa-times"></i> إلغاء
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- نافذة تعديل السجل -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>تعديل السجل</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editUniqueId">
          <div class="form-group">
            <label for="editDate" class="form-label">تاريخ الشهادة *</label>
            <input type="date" id="editDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="editDriver" class="form-label">اسم السائق *</label>
            <input type="text" id="editDriver" class="form-control" list="driversList" required>
          </div>
          <div class="form-group">
            <label for="editCertNumber" class="form-label">رقم الشهادة *</label>
            <input type="text" id="editCertNumber" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="editSchoolName" class="form-label">اسم المدرسة *</label>
            <input type="text" id="editSchoolName" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="editManagerPhone" class="form-label">هاتف المدير</label>
            <input type="text" id="editManagerPhone" class="form-control">
          </div>
          <div class="form-group">
            <label for="editNotes" class="form-label">ملاحظة</label>
            <input type="text" id="editNotes" class="form-control">
          </div>
          
          <!-- أزرار الموافقة/الرفض للمشرفين -->
          <div id="approvalButtons" class="action-buttons" style="margin-top: 20px; display: none;">
            <button type="button" id="approveBtn" class="btn btn-success">
              <i class="fas fa-check"></i> الموافقة
            </button>
            <button type="button" id="rejectBtn" class="btn btn-danger">
              <i class="fas fa-times"></i> الرفض
            </button>
          </div>
          
          <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> حفظ التعديلات
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // إعدادات النظام
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5Ie9jqKvOF5C3S2AUHVMIcc_D71Dw5dQa-8f4nm8ORpW7PkYEjqFuL886hjOMwUGP/exec";
    const SPREADSHEET_ID = "1h2pTg1PUDn5s8QPEWCKNGoo9lho42UJzUg8ljDFTm0w";
    const SHEET_NAME = "الشهادات";
    const EMPLOYEES_SHEET = "الموظفين";
    const USERS_SHEET = "المستخدمين";
    const RECORDS_PER_PAGE = 20;
    
    // توقيت الرياض (UTC+3)
    const riyadhTimeZone = 'Asia/Riyadh';
    
    // متغيرات النظام
    let currentUser = null;
    let currentUsername = null;
    let currentUserRole = 0;
    let currentRecords = [];
    let currentPage = 1;
    let totalPages = 1;
    let driversList = [];
    let currentEditingRecord = null;
    let selectedRecords = [];
    
    // تعيين تاريخ اليوم بدون وقت
    function setTodayDate() {
      const today = new Date();
      // تحويل التاريخ إلى توقيت الرياض
      const todayStr = today.toLocaleDateString('en-CA', { timeZone: riyadhTimeZone });
      document.getElementById('date').value = todayStr;
      document.getElementById('editDate').value = todayStr;
    }
    
    // إنشاء رمز المستخدم
    function createUserAvatar(name) {
      if (!name) return '';
      const parts = name.split(' ');
      let initials = parts[0].charAt(0);
      if (parts.length > 1) {
        initials += parts[1].charAt(0);
      }
      return initials.toUpperCase();
    }
    
    // دالة لعرض التاريخ بتنسيق DD/MM/YYYY (أرقام إنجليزية)
    function formatDisplayDate(dateStr) {
      if (!dateStr) return '-';
      
      try {
        // إنشاء تاريخ في توقيت الرياض
        const date = new Date(dateStr);
        const options = { timeZone: riyadhTimeZone, year: 'numeric', month: '2-digit', day: '2-digit' };
        const formatted = date.toLocaleDateString('en-GB', options);
        
        // إعادة ترتيب المكونات لتصبح DD/MM/YYYY
        const [day, month, year] = formatted.split('/');
        return `${day}/${month}/${year}`;
      } catch (e) {
        console.error("Error formatting date:", e);
        return '-';
      }
    }
    
    // دالة لعرض التاريخ والوقت بتنسيق DD/MM/YYYY HH:MM:SS (أرقام إنجليزية)
    function formatDisplayDateTime(dateStr) {
      if (!dateStr) return '-';
      
      try {
        // إنشاء تاريخ في توقيت الرياض
        const date = new Date(dateStr);
        const dateOptions = { timeZone: riyadhTimeZone, year: 'numeric', month: '2-digit', day: '2-digit' };
        const timeOptions = { timeZone: riyadhTimeZone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        
        const formattedDate = date.toLocaleDateString('en-GB', dateOptions);
        const formattedTime = date.toLocaleTimeString('en-GB', timeOptions);
        
        // إعادة ترتيب مكونات التاريخ لتصبح DD/MM/YYYY
        const [day, month, year] = formattedDate.split('/');
        return `${day}/${month}/${year} ${formattedTime}`;
      } catch (e) {
        console.error("Error formatting datetime:", e);
        return '-';
      }
    }
    
    // تحويل التاريخ من تنسيق YYYY-MM-DD إلى كائن تاريخ في توقيت الرياض
    function parseRiyadhDate(dateStr) {
      if (!dateStr) return null;
      
      try {
        // إنشاء تاريخ في توقيت الرياض
        const [year, month, day] = dateStr.split('-');
        const date = new Date(Date.UTC(year, month - 1, day));
        
        // تعديل التاريخ حسب توقيت الرياض (UTC+3)
        return new Date(date.getTime() + (3 * 60 * 60 * 1000));
      } catch (e) {
        console.error("Error parsing date:", e);
        return null;
      }
    }
    
    // الحصول على الشهر والسنة من تاريخ معين (في توقيت الرياض)
    function getMonthYearFromDate(dateStr) {
      const date = parseRiyadhDate(dateStr);
      if (!date) return { month: 0, year: 0 };
      
      return {
        month: date.getMonth() + 1,
        year: date.getFullYear()
      };
    }
    
    // عرض الرسالة
    function showMessage(type, message) {
      const messageDiv = document.getElementById('message');
      const messageText = document.getElementById('messageText');
      
      messageDiv.className = `alert alert-${type}`;
      messageDiv.classList.remove('hidden');
      messageText.innerHTML = message;
      
      setTimeout(() => {
        messageDiv.className = "alert hidden";
        messageText.textContent = "";
      }, 5000);
    }
    
    // جلب سجلات الموظفين (السائقين)
    async function fetchDrivers() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=getEmployees&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(EMPLOYEES_SHEET)}`
        });
        
        const result = await response.json();
        
        if (result.success && result.employees) {
          driversList = result.employees;
          const driversListElement = document.getElementById('driversList');
          driversListElement.innerHTML = '';
          
          // تصفية الموظفين الذين لديهم كلمة "سائق" في الاسم
          const drivers = result.employees.filter(emp => 
            emp.name && emp.name.includes('سائق')
          );
          
          drivers.forEach(driver => {
            const option = document.createElement('option');
            option.value = driver.name;
            driversListElement.appendChild(option);
          });
        }
      } catch (error) {
        console.error("Error fetching drivers:", error);
        showMessage('danger', "حدث خطأ أثناء جلب بيانات السائقين");
      }
    }
    
    // جلب السجلات مع التصفية حسب التاريخ والحالة
    async function fetchRecords(filterDays = null, statusFilter = 'all') {
      let filterDate = null;
      
      if (filterDays === 'month') {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        filterDate = firstDayOfMonth.toISOString().split('T')[0];
      } else if (filterDays && filterDays !== 'all') {
        const today = new Date();
        const filterDateObj = new Date(today);
        filterDateObj.setDate(today.getDate() - parseInt(filterDays));
        filterDate = filterDateObj.toISOString().split('T')[0];
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=getRecords&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}${filterDate ? `&filterDate=${filterDate}` : ''}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentRecords = result.records;
          
          // تطبيق فلترة الحالة إذا كانت محددة
          if (statusFilter && statusFilter !== 'all') {
            currentRecords = currentRecords.filter(record => record.status === statusFilter);
          }
          
          // ترتيب السجلات من الأحدث إلى الأقدم
          currentRecords.sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate));
          displayRecords(currentRecords);
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء جلب السجلات");
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
      }
    }
    
    // البحث عن سجلات برقم الشهادة
    async function searchRecords(certNumber) {
      if (!certNumber) {
        showMessage('warning', "الرجاء إدخال رقم الشهادة للبحث");
        return;
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=searchRecords&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}&certNumber=${encodeURIComponent(certNumber)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentRecords = result.records;
          displayRecords(currentRecords);
          showMessage('success', `تم العثور على ${currentRecords.length} سجل`);
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء البحث");
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
      }
    }
    
    // عرض السجلات في الجدول مع التقسيم إلى صفحات
    function displayRecords(records) {
      const tbody = document.getElementById('recordsBody');
      const noRecords = document.getElementById('noRecords');
      const pagination = document.getElementById('pagination');
      const bulkActions = document.getElementById('bulkActions');
      tbody.innerHTML = '';
      pagination.innerHTML = '';
      selectedRecords = [];
      bulkActions.style.display = 'none';
      
      if (records.length === 0) {
        noRecords.classList.remove('hidden');
        return;
      }
      
      noRecords.classList.add('hidden');
      
      // حساب عدد الصفحات
      totalPages = Math.ceil(records.length / RECORDS_PER_PAGE);
      
      // عرض السجلات للصفحة الحالية فقط
      const startIndex = (currentPage - 1) * RECORDS_PER_PAGE;
      const endIndex = Math.min(startIndex + RECORDS_PER_PAGE, records.length);
      const pageRecords = records.slice(startIndex, endIndex);
      
      pageRecords.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'fade-in';
        row.dataset.uniqueId = record.uniqueId;
        
        // خانة الاختيار
        const selectCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'record-checkbox';
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedRecords.push(record.uniqueId);
          } else {
            selectedRecords = selectedRecords.filter(id => id !== record.uniqueId);
          }
          updateBulkActions();
        });
        selectCell.appendChild(checkbox);
        row.appendChild(selectCell);
        
        // بقية الخلايا
        const dateCell = document.createElement('td');
        dateCell.textContent = formatDisplayDate(record.date) || '-';
        row.appendChild(dateCell);
        
        const driverCell = document.createElement('td');
        driverCell.textContent = record.driver || '-';
        row.appendChild(driverCell);
        
        const certCell = document.createElement('td');
        certCell.textContent = record.certNumber || '-';
        row.appendChild(certCell);
        
        const schoolCell = document.createElement('td');
        schoolCell.textContent = record.schoolName || '-';
        row.appendChild(schoolCell);
        
        const phoneCell = document.createElement('td');
        phoneCell.textContent = record.managerPhone || '-';
        row.appendChild(phoneCell);
        
        const notesCell = document.createElement('td');
        notesCell.textContent = record.notes || '-';
        row.appendChild(notesCell);
        
        const userCell = document.createElement('td');
        userCell.textContent = record.user || '-';
        row.appendChild(userCell);
        
        const statusCell = document.createElement('td');
        const statusSpan = document.createElement('span');
        statusSpan.textContent = record.status || 'قيد الانتظار';
        
        if (record.status === 'معتمد') {
          statusSpan.className = 'status-approved';
          statusSpan.innerHTML = `<i class="fas fa-check-circle status-icon"></i> ${statusSpan.textContent}`;
        } else if (record.status === 'مرفوض') {
          statusSpan.className = 'status-rejected';
          statusSpan.innerHTML = `<i class="fas fa-times-circle status-icon"></i> ${statusSpan.textContent}`;
        } else {
          statusSpan.className = 'status-pending';
          statusSpan.innerHTML = `<i class="fas fa-clock status-icon"></i> ${statusSpan.textContent}`;
        }
        
        statusCell.appendChild(statusSpan);
        row.appendChild(statusCell);
        
        const actionsCell = document.createElement('td');
        actionsCell.style.display = 'flex';
        actionsCell.style.gap = '5px';
        
        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-sm';
        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
        viewBtn.title = 'عرض التفاصيل';
        viewBtn.addEventListener('click', () => showRecordDetails(record));
        actionsCell.appendChild(viewBtn);
        
        // عرض زر التعديل فقط للمستخدمين ذوي صلاحية 10 فأعلى
        if (currentUserRole >= 10) {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-warning btn-sm';
          editBtn.innerHTML = '<i class="fas fa-edit"></i>';
          editBtn.title = 'تعديل السجل';
          editBtn.addEventListener('click', () => editRecord(record));
          actionsCell.appendChild(editBtn);
        }
        
        row.appendChild(actionsCell);
        tbody.appendChild(row);
      });
      
      // إنشاء عناصر التقسيم إلى صفحات
      if (totalPages > 1) {
        for (let i = 1; i <= totalPages; i++) {
          const pageItem = document.createElement('li');
          pageItem.className = 'page-item';
          
          const pageLink = document.createElement('a');
          pageLink.className = `page-link ${i === currentPage ? 'active' : ''}`;
          pageLink.href = '#';
          pageLink.textContent = i;
          pageLink.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            displayRecords(currentRecords);
          });
          
          pageItem.appendChild(pageLink);
          pagination.appendChild(pageItem);
        }
      }
      
      // تحديث خانة الاختيار الكلي
      document.getElementById('selectAllCheckbox').checked = false;
    }
    
    // تحديث شريط الإجراءات الجماعية
    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      
      if (selectedRecords.length > 0) {
        bulkActions.style.display = 'flex';
        selectedCount.textContent = `${selectedRecords.length} سجل محدد`;
      } else {
        bulkActions.style.display = 'none';
      }
    }
    
    // الموافقة على السجلات المحددة
    async function approveSelectedRecords() {
      if (selectedRecords.length === 0) {
        showMessage('warning', "الرجاء تحديد سجلات للموافقة عليها");
        return;
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=bulkUpdateStatus&uniqueIds=${encodeURIComponent(JSON.stringify(selectedRecords))}&status=معتمد&user=${encodeURIComponent(currentUser)}&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', `تم الموافقة على ${selectedRecords.length} سجل بنجاح`);
          selectedRecords = [];
          document.getElementById('bulkActions').style.display = 'none';
          fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء الموافقة على السجلات");
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
      }
    }
    
    // رفض السجلات المحددة
    async function rejectSelectedRecords() {
      if (selectedRecords.length === 0) {
        showMessage('warning', "الرجاء تحديد سجلات للرفض");
        return;
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=bulkUpdateStatus&uniqueIds=${encodeURIComponent(JSON.stringify(selectedRecords))}&status=مرفوض&user=${encodeURIComponent(currentUser)}&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', `تم رفض ${selectedRecords.length} سجل بنجاح`);
          selectedRecords = [];
          document.getElementById('bulkActions').style.display = 'none';
          fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء رفض السجلات");
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
      }
    }
    
    // عرض تفاصيل السجل في نافذة منبثقة
    function showRecordDetails(record) {
      const modal = document.getElementById('detailsModal');
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = '';
      
      const fields = [
        { label: 'التاريخ', value: formatDisplayDate(record.date) },
        { label: 'السائق', value: record.driver },
        { label: 'رقم الشهادة', value: record.certNumber },
        { label: 'اسم المدرسة', value: record.schoolName },
        { label: 'هاتف المدير', value: record.managerPhone || 'لا يوجد' },
        { label: 'ملاحظة', value: record.notes || 'لا يوجد' },
        { label: 'مسجل بواسطة', value: record.user },
        { label: 'حالة الطلب', value: record.status || 'قيد الانتظار' },
        { label: 'معتمد بواسطة', value: record.approvedBy || 'لم يتم الاعتماد بعد' },
        { label: 'تاريخ ووقت التسجيل', value: formatDisplayDateTime(record.registrationDate) },
        { label: 'تاريخ ووقت الاعتماد', value: record.approvalDate ? formatDisplayDateTime(record.approvalDate) : 'لم يتم الاعتماد بعد' },
        { label: 'تاريخ ووقت آخر نشاط', value: record.lastActivityDate ? formatDisplayDateTime(record.lastActivityDate) : 'لا يوجد نشاط' },
        { label: 'آخر نشاط بواسطة', value: record.lastActivityBy || 'لا يوجد' },
        { label: 'وصف آخر نشاط', value: record.lastActivityDesc || 'لا يوجد' },
        { label: 'عدد التعديلات', value: record.editCount || '0' },
        { label: 'المعرف الفريد', value: record.uniqueId || 'غير معروف' }
      ];
      
      fields.forEach(field => {
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'modal-field';
        
        const label = document.createElement('div');
        label.className = 'modal-label';
        label.textContent = field.label;
        
        const value = document.createElement('div');
        value.className = 'modal-value';
        value.textContent = field.value;
        
        fieldDiv.appendChild(label);
        fieldDiv.appendChild(value);
        modalBody.appendChild(fieldDiv);
      });
      
      modal.style.display = 'flex';
      
      // إغلاق النافذة عند النقر على الزر
      document.querySelector('#detailsModal .modal-close').addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }
    
    // فتح نافذة تعديل السجل
    function editRecord(record) {
      currentEditingRecord = record;
      const modal = document.getElementById('editModal');
      
      // تعبئة النموذج ببيانات السجل
      document.getElementById('editUniqueId').value = record.uniqueId;
      document.getElementById('editDate').value = record.date;
      document.getElementById('editDriver').value = record.driver;
      document.getElementById('editCertNumber').value = record.certNumber;
      document.getElementById('editSchoolName').value = record.schoolName;
      document.getElementById('editManagerPhone').value = record.managerPhone || '';
      document.getElementById('editNotes').value = record.notes || '';
      
      // إظهار أزرار الموافقة/الرفض فقط للمشرفين (صلاحية 8 فأعلى) وللسجلات غير المعتمدة/المرفوضة
      const approvalButtons = document.getElementById('approvalButtons');
      const showApprovalButtons = currentUserRole >= 8 && (!record.status || record.status === 'قيد الانتظار');
      approvalButtons.style.display = showApprovalButtons ? 'flex' : 'none';
      
      modal.style.display = 'flex';
      
      // إغلاق النافذة عند النقر على الزر
      document.querySelector('#editModal .modal-close').addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }
    
    // إضافة صف سجل جديد
    function addCarRow(driver = '', certNumber = '', school = '', phone = '', notes = '') {
      const container = document.getElementById('carsContainer');
      const row = document.createElement('tr');
      row.className = 'fade-in';
      row.innerHTML = `
        <td>
          <input type="text" class="form-control driver-name" value="${driver}" list="driversList" placeholder="اسم السائق" required>
        </td>
        <td><input type="text" class="form-control certificate-number" value="${certNumber}" placeholder="رقم الشهادة" required></td>
        <td><input type="text" class="form-control school-name" value="${school}" placeholder="اسم المدرسة" required></td>
        <td><input type="text" class="form-control manager-phone" value="${phone}" placeholder="هاتف المدير"></td>
        <td><input type="text" class="form-control notes" value="${notes}" placeholder="ملاحظة"></td>
        <td>
          <button type="button" class="btn btn-danger btn-sm remove-car">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      container.appendChild(row);
      
      // تفعيل زر الحذف إذا كان هناك أكثر من صف
      if (container.children.length > 1) {
        container.querySelectorAll('.remove-car').forEach(btn => {
          btn.disabled = false;
        });
      }
      
      // إضافة حدث للحذف
      row.querySelector('.remove-car').addEventListener('click', function() {
        row.classList.add('hidden');
        setTimeout(() => {
          row.remove();
          
          // تعطيل زر الحذف إذا بقي صف واحد فقط
          if (container.children.length <= 1) {
            container.querySelector('.remove-car').disabled = true;
          }
        }, 300);
      });
      
      // التحقق من اسم السائق عند فقدان التركيز
      const driverInput = row.querySelector('.driver-name');
      driverInput.addEventListener('blur', function() {
        const driverName = this.value.trim();
        if (driverName && !driversList.some(driver => driver.name === driverName)) {
          showMessage('warning', "اسم السائق غير موجود في القائمة، الرجاء اختيار اسم من القائمة");
          this.value = '';
          this.focus();
        }
      });
    }
    
    // جمع بيانات السجلات من النموذج
    function gatherRecordsData() {
      const date = document.getElementById('date').value;
      const records = [];
      const errors = [];
      
      document.querySelectorAll('#carsContainer tr:not(.hidden)').forEach((row, index) => {
        const driver = row.querySelector('.driver-name').value.trim();
        const certNumber = row.querySelector('.certificate-number').value.trim();
        const school = row.querySelector('.school-name').value.trim();
        const phone = row.querySelector('.manager-phone')?.value.trim() || '';
        const notes = row.querySelector('.notes')?.value.trim() || '';
        
        // التحقق من الحقول الإجبارية
        if (!driver) {
          errors.push(`اسم السائق في الصف ${index + 1} مطلوب`);
          row.querySelector('.driver-name').focus();
        }
        
        if (!certNumber) {
          errors.push(`رقم الشهادة في الصف ${index + 1} مطلوب`);
          if (!errors.length) row.querySelector('.certificate-number').focus();
        }
        
        if (!school) {
          errors.push(`اسم المدرسة في الصف ${index + 1} مطلوب`);
          if (!errors.length) row.querySelector('.school-name').focus();
        }
        
        // التحقق من أن اسم السائق موجود في القائمة
        if (driver && !driversList.some(d => d.name === driver)) {
          errors.push(`اسم السائق '${driver}' غير موجود في القائمة`);
          if (!errors.length) row.querySelector('.driver-name').focus();
        }
        
        // تجاهل الصفوف الفارغة تماماً
        if (driver || certNumber || school || phone || notes) {
          if (!errors.length) {
            records.push({
              date,
              driver,
              certNumber,
              school,
              phone,
              notes
            });
          }
        }
      });
      
      // إذا كانت جميع الصفوف فارغة
      if (records.length === 0 && errors.length === 0) {
        errors.push("الرجاء إدخال بيانات السجلات");
      }
      
      return { records, errors };
    }
    
    // عرض تأكيد الإضافة
    function showConfirmationModal(records) {
      const modal = document.getElementById('confirmModal');
      const recordsList = document.getElementById('confirmRecordsList');
      recordsList.innerHTML = '<h4>السجلات التي سيتم إضافتها:</h4>';
      
      const list = document.createElement('ul');
      list.style.marginRight = '20px';
      
      records.forEach(record => {
        const item = document.createElement('li');
        item.style.marginBottom = '10px';
        item.innerHTML = `
          <strong>${record.driver}</strong> - 
          رقم الشهادة: ${record.certNumber} - 
          المدرسة: ${record.school}
          ${record.phone ? `- هاتف المدير: ${record.phone}` : ''}
          ${record.notes ? `<br><small>ملاحظة: ${record.notes}</small>` : ''}
        `;
        list.appendChild(item);
      });
      
      recordsList.appendChild(list);
      modal.style.display = 'flex';
      
      // إعداد أحداث الأزرار
      document.getElementById('confirmSubmitBtn').onclick = () => {
        modal.style.display = 'none';
        submitRecords(records);
      };
      
      document.getElementById('cancelSubmitBtn').onclick = () => {
        modal.style.display = 'none';
      };
      
      // إغلاق النافذة عند النقر على الزر
      document.querySelector('#confirmModal .modal-close').addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }
    
    // إرسال السجلات إلى الخادم
    async function submitRecords(records) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=addMultipleRecords&user=${encodeURIComponent(currentUser)}&records=${encodeURIComponent(JSON.stringify(records))}&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', `تم حفظ ${records.length} سجل بنجاح`);
          
          // إعادة تعيين النموذج مع الاحتفاظ بصف واحد
          const container = document.getElementById('carsContainer');
          container.innerHTML = `
            <tr>
              <td>
                <input type="text" class="form-control driver-name" list="driversList" placeholder="اسم السائق" required>
              </td>
              <td><input type="text" class="form-control certificate-number" placeholder="رقم الشهادة" required></td>
              <td><input type="text" class="form-control school-name" placeholder="اسم المدرسة" required></td>
              <td><input type="text" class="form-control manager-phone" placeholder="هاتف المدير"></td>
              <td><input type="text" class="form-control notes" placeholder="ملاحظة"></td>
              <td>
                <button type="button" class="btn btn-danger btn-sm remove-car" disabled>
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
          
          setTodayDate();
          fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
          
          // التبديل إلى تبويب السجلات بعد الحفظ
          switchTab('records');
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء حفظ البيانات");
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
      }
    }
    
    // تحديث حالة السجل (موافقة/رفض)
    async function updateRecordStatus(status) {
      if (!currentEditingRecord) return;
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=updateRecordStatus&uniqueId=${currentEditingRecord.uniqueId}&status=${encodeURIComponent(status)}&user=${encodeURIComponent(currentUser)}&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', `تم ${status === 'معتمد' ? 'الموافقة على' : 'رفض'} السجل بنجاح`);
          document.getElementById('editModal').style.display = 'none';
          fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء تحديث حالة السجل");
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
      }
    }
    
    // حفظ التعديلات على السجل
    async function saveRecordEdits() {
      const date = document.getElementById('editDate').value;
      const driver = document.getElementById('editDriver').value.trim();
      const certNumber = document.getElementById('editCertNumber').value.trim();
      const schoolName = document.getElementById('editSchoolName').value.trim();
      const managerPhone = document.getElementById('editManagerPhone').value.trim() || '';
      const notes = document.getElementById('editNotes').value.trim() || '';
      
      // التحقق من الحقول الإجبارية
      if (!date || !driver || !certNumber || !schoolName) {
        showMessage('danger', "جميع الحقول المطلوبة يجب تعبئتها");
        return false;
      }
      
      // التحقق من أن اسم السائق موجود في القائمة
      if (!driversList.some(d => d.name === driver)) {
        showMessage('danger', "اسم السائق غير موجود في القائمة");
        return false;
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=editRecord&uniqueId=${currentEditingRecord.uniqueId}&date=${date}&driver=${encodeURIComponent(driver)}&certNumber=${encodeURIComponent(certNumber)}&schoolName=${encodeURIComponent(schoolName)}&managerPhone=${managerPhone}&notes=${encodeURIComponent(notes)}&user=${encodeURIComponent(currentUser)}&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(SHEET_NAME)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('success', "تم تعديل السجل بنجاح");
          document.getElementById('editModal').style.display = 'none';
          fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
          return true;
        } else {
          showMessage('danger', result.message || "حدث خطأ أثناء تعديل السجل");
          return false;
        }
      } catch (error) {
        showMessage('danger', "حدث خطأ في الاتصال بالخادم");
        return false;
      }
    }
    
    // عرض تأكيد الإجراء
    function showActionConfirmation(action, message, callback) {
      const modal = document.getElementById('actionConfirmModal');
      const title = document.getElementById('actionConfirmTitle');
      const msg = document.getElementById('actionConfirmMessage');
      
      title.textContent = `تأكيد ${action}`;
      msg.textContent = message;
      modal.style.display = 'flex';
      
      // إعداد أحداث الأزرار
      document.getElementById('proceedActionBtn').onclick = () => {
        modal.style.display = 'none';
        callback();
      };
      
      document.getElementById('cancelActionBtn').onclick = () => {
        modal.style.display = 'none';
      };
      
      // إغلاق النافذة عند النقر على الزر
      document.querySelector('#actionConfirmModal .modal-close').addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }
    
    // التبديل بين التبويبات
    function switchTab(tabId) {
      // إخفاء جميع التبويبات
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // إظهار التبويب المحدد
      document.getElementById(`${tabId}Tab`).classList.remove('hidden');
      
      // تحديث حالة التبويبات النشطة
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabId) {
          tab.classList.add('active');
        }
      });
      
      // إذا كان التبويب هو سجلات الشهادات، قم بتحديث السجلات
      if (tabId === 'records') {
        fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
      }
    }
    
    // تسجيل الدخول
document.getElementById('loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const messageDiv = document.getElementById('loginMessage');
  
  // إظهار تحميل
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';
  submitBtn.disabled = true;
  
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&spreadsheetId=${SPREADSHEET_ID}&sheetName=${encodeURIComponent(USERS_SHEET)}`
    });
    
    const result = await response.json();
    
    if (result.success) {
      // تخزين بيانات المستخدم في المتغيرات العامة
      currentUser = result.user.name;
      currentUsername = result.user.username;
      currentUserRole = result.user.role;
      
      // إخفاء شاشة الدخول وإظهار التطبيق
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');
      
      // الآن فقط نقوم بتعيين بيانات المستخدم بعد التأكد من وجود العناصر
      const currentUserElement = document.getElementById('currentUser');
      const userAvatarElement = document.getElementById('userAvatar');
      
      if (currentUserElement && userAvatarElement) {
        currentUserElement.textContent = currentUser;
        userAvatarElement.textContent = createUserAvatar(currentUser);
      }
      
      // تحميل البيانات الأولية
      setTodayDate();
      fetchDrivers();
      fetchRecords();
      
      // إظهار رسالة ترحيبية
      showMessage('success', `مرحباً ${currentUser}! تم تسجيل الدخول بنجاح`);
    } else {
      messageDiv.textContent = result.message || "بيانات الدخول غير صحيحة";
      messageDiv.className = "alert alert-danger";
      messageDiv.classList.remove('hidden');
    }
  } catch (error) {
    console.error("Login error:", error);
    messageDiv.textContent = "حدث خطأ في الاتصال بالخادم";
    messageDiv.className = "alert alert-danger";
    messageDiv.classList.remove('hidden');
  } finally {
    // إعادة زر التسجيل إلى حالته الأصلية
    submitBtn.innerHTML = originalBtnText;
    submitBtn.disabled = false;
  }
});
    
    // إرسال البيانات
    document.getElementById('dataForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const { records, errors } = gatherRecordsData();
      
      if (errors.length > 0) {
        showMessage('danger', errors.join('<br>'));
        return;
      }
      
      if (records.length === 0) {
        showMessage('danger', "الرجاء إدخال بيانات صحيحة للسجلات");
        return;
      }
      
      showConfirmationModal(records);
    });
    
    // زر إضافة سجل
    document.getElementById('addCarBtn').addEventListener('click', function() {
      addCarRow();
    });
    
    // زر تحديث السجلات
    document.getElementById('refreshBtn').addEventListener('click', function() {
      fetchRecords(document.getElementById('timeFilter').value, document.getElementById('statusFilter').value);
      currentPage = 1;
      showMessage('success', "تم تحديث السجلات بنجاح");
    });
    
    // زر البحث
    document.getElementById('searchBtn').addEventListener('click', function() {
      const certNumber = document.getElementById('searchInput').value.trim();
      searchRecords(certNumber);
    });
    
    // البحث عند الضغط على Enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const certNumber = this.value.trim();
        searchRecords(certNumber);
      }
    });
    
    // تصفية السجلات حسب التاريخ
    document.getElementById('timeFilter').addEventListener('change', function() {
      const value = this.value;
      fetchRecords(value, document.getElementById('statusFilter').value);
      currentPage = 1;
    });
    
    // تصفية السجلات حسب الحالة
    document.getElementById('statusFilter').addEventListener('change', function() {
      const value = this.value;
      fetchRecords(document.getElementById('timeFilter').value, value);
      currentPage = 1;
    });
    
    // إرسال تعديلات السجل
    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      await saveRecordEdits();
    });
    
    // زر الموافقة على السجل
    document.getElementById('approveBtn').addEventListener('click', function() {
      showActionConfirmation('الموافقة', 'هل أنت متأكد من الموافقة على هذا السجل؟', () => {
        updateRecordStatus('معتمد');
      });
    });
    
    // زر الرفض على السجل
    document.getElementById('rejectBtn').addEventListener('click', function() {
      showActionConfirmation('الرفض', 'هل أنت متأكد من رفض هذا السجل؟', () => {
        updateRecordStatus('مرفوض');
      });
    });
    
    // زر الموافقة على السجلات المحددة
    document.getElementById('approveSelectedBtn').addEventListener('click', function() {
      showActionConfirmation('الموافقة', `هل أنت متأكد من الموافقة على ${selectedRecords.length} سجل؟`, () => {
        approveSelectedRecords();
      });
    });
    
    // زر رفض السجلات المحددة
    document.getElementById('rejectSelectedBtn').addEventListener('click', function() {
      showActionConfirmation('الرفض', `هل أنت متأكد من رفض ${selectedRecords.length} سجل؟`, () => {
        rejectSelectedRecords();
      });
    });
    
    // زر إلغاء التحديد
    document.getElementById('clearSelectionBtn').addEventListener('click', function() {
      document.querySelectorAll('.record-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      selectedRecords = [];
      document.getElementById('bulkActions').style.display = 'none';
      document.getElementById('selectAllCheckbox').checked = false;
    });
    
    // تحديد/إلغاء تحديد جميع السجلات
    document.getElementById('selectAllCheckbox').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.record-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      
      if (this.checked) {
        selectedRecords = Array.from(document.querySelectorAll('tr[data-unique-id]')).map(row => row.dataset.uniqueId);
      } else {
        selectedRecords = [];
      }
      
      updateBulkActions();
    });
    
    // التبديل بين التبويبات
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        switchTab(this.dataset.tab);
      });
    });
    
    // إغلاق النوافذ المنبثقة عند النقر خارجها
    window.addEventListener('click', function(e) {
      if (e.target.className === 'modal') {
        e.target.style.display = 'none';
      }
    });
    
    // تعيين تاريخ اليوم عند تحميل الصفحة
    window.onload = function() {
      setTodayDate();
      
      // إخفاء شاشة التحميل بعد ثانيتين (في حالة عدم وجود اتصال)
      setTimeout(() => {
        document.getElementById('loaderScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
      }, 2000);
    };
  </script>
</body>
</html>
